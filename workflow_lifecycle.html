

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Workflows/Lifecycles &mdash; Talus 0.0.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Talus 0.0.1 documentation" href="index.html"/>
        <link rel="prev" title="Debugging Talus" href="debugging.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Talus
          

          
          </a>

          
            
            
              <div class="version">
                0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Debugging Talus</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Workflows/Lifecycles</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#image">Image</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#import">Import</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#code">Code</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#cli-code-create">CLI Code Create</a></li>
<li class="toctree-l3"><a class="reference internal" href="#git-repo">Git Repo</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#pre-receive">Pre-Receive</a></li>
<li class="toctree-l4"><a class="reference internal" href="#post-receive">Post-Receive</a></li>
<li class="toctree-l4"><a class="reference internal" href="#code-cache">Code Cache</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#task">Task</a></li>
<li class="toctree-l2"><a class="reference internal" href="#job">Job</a></li>
<li class="toctree-l2"><a class="reference internal" href="#results">Results</a></li>
<li class="toctree-l2"><a class="reference internal" href="#crashes">Crashes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#master-daemon">Master Daemon</a></li>
<li class="toctree-l2"><a class="reference internal" href="#slave-daemon">Slave Daemon</a></li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Talus</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Workflows/Lifecycles</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/workflow_lifecycle.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="workflows-lifecycles">
<h1>Workflows/Lifecycles<a class="headerlink" href="#workflows-lifecycles" title="Permalink to this headline">¶</a></h1>
<p>Almost all methods of interacting with talus occur through the database. The
REST API that is exposed is the front-end to the database that UIs will use
to make changes to talus.</p>
<p>The general methodology goes like this:</p>
<ol class="arabic">
<li><p class="first">Make a change to a model in the database through the REST API</p>
</li>
<li><p class="first">Master daemon sees the change in the replica set oplog and acts on it</p>
</li>
<li><dl class="first docutils">
<dt>Master daemon moves the model from the intermediate state to the final state</dt>
<dd><ul class="first last simple">
<li>E.g. A job will go from cancel -&gt; (master daemon sees it) cancelling -&gt; (master daemon finished cancelling) cancelled</li>
</ul>
</dd>
</dl>
</li>
</ol>
<div class="section" id="image">
<h2>Image<a class="headerlink" href="#image" title="Permalink to this headline">¶</a></h2>
<div class="section" id="import">
<h3>Import<a class="headerlink" href="#import" title="Permalink to this headline">¶</a></h3>
<p>Upload the VM image as temporary file, receive a temporary file id in return (gets saved as a <code class="code docutils literal"><span class="pre">TmpFile</span></code> model):</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># (from models.py in talus/src/web/app/api/models.py)</span>
<span class="k">class</span> <span class="nc">TmpFile</span><span class="p">(</span><span class="n">Document</span><span class="p">):</span>
   <span class="n">path</span>             <span class="o">=</span> <span class="n">StringField</span><span class="p">(</span><span class="n">unique</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Create a new image in the database with the status.name set to &#8220;import&#8221; and status.tmpfile set to the temporary
file id:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># in talus_client/talus_client/api.py</span>
<span class="k">class</span> <span class="nc">TalusClient</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="k">def</span> <span class="nf">image_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
        <span class="c"># ...</span>
        <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">api_base</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_base</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prep_model</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="n">image</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">image_name</span>
        <span class="n">image</span><span class="o">.</span><span class="n">os</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">id</span>
        <span class="n">image</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span>
        <span class="n">image</span><span class="o">.</span><span class="n">tags</span> <span class="o">=</span> <span class="n">tags</span>
        <span class="n">image</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="s">&quot;import&quot;</span><span class="p">,</span> <span class="s">&quot;tmpfile&quot;</span><span class="p">:</span> <span class="n">uploaded_file</span><span class="p">}</span>
        <span class="n">image</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>
        <span class="n">image</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>
        <span class="n">image</span><span class="o">.</span><span class="n">timestamps</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;created&quot;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()}</span>
        <span class="n">image</span><span class="o">.</span><span class="n">md5</span> <span class="o">=</span> <span class="s">&quot;blahblah&quot;</span>

        <span class="n">image</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
</div>
<p>At this point the master daemon will catch the new image insertion and see the status as being import.
The master daemon will then handle the import:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># in talus/src/master/watchers/vm.py</span>
    <span class="k">def</span> <span class="nf">_handle_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="n">switch</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s">&quot;import&quot;</span><span class="p">:</span>               <span class="bp">self</span><span class="o">.</span><span class="n">_handle_import</span><span class="p">,</span>
                    <span class="s">&quot;configure&quot;</span><span class="p">:</span>    <span class="bp">self</span><span class="o">.</span><span class="n">_handle_configure</span><span class="p">,</span>
                    <span class="s">&quot;create&quot;</span><span class="p">:</span>               <span class="bp">self</span><span class="o">.</span><span class="n">_handle_create</span><span class="p">,</span>
                    <span class="s">&quot;delete&quot;</span><span class="p">:</span>               <span class="bp">self</span><span class="o">.</span><span class="n">_handle_delete</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">images</span> <span class="o">=</span> <span class="n">master</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="k">return</span>
                    <span class="n">image</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">switch</span><span class="p">:</span>
                    <span class="n">switch</span><span class="p">[</span><span class="n">image</span><span class="o">.</span><span class="n">status</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]](</span><span class="n">id_</span><span class="p">,</span> <span class="n">image</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_handle_import</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
    <span class="c"># ...</span>
            <span class="n">vnc_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vm_manager</span><span class="o">.</span><span class="n">import_image</span><span class="p">(</span>
                    <span class="n">image_path</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="c"># image name</span>
                    <span class="n">user_interaction</span>        <span class="o">=</span> <span class="bp">True</span><span class="p">,</span>
                    <span class="n">username</span>                        <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
                    <span class="n">password</span>                        <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">password</span><span class="p">,</span>
                    <span class="n">on_success</span>                      <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set_image_ready</span>
            <span class="p">)</span>
</pre></div>
</div>
<p>At this point the VMManager will start <a href="#id1"><span class="problematic" id="id2">Vagrant_</span></a> and will import the image. Once the
vm has been shutdown (restarts are fine), the image will be saved and its status
will be cleared to <code class="code docutils literal"><span class="pre">{&quot;name&quot;:</span> <span class="pre">&quot;ready&quot;}</span></code>.</p>
<p>The VMManager is found at <code class="code docutils literal"><span class="pre">talus/src/master/lib/vm/manage.py</span></code></p>
</div>
</div>
<div class="section" id="code">
<h2>Code<a class="headerlink" href="#code" title="Permalink to this headline">¶</a></h2>
<div class="section" id="cli-code-create">
<h3>CLI Code Create<a class="headerlink" href="#cli-code-create" title="Permalink to this headline">¶</a></h3>
<p>Creating code through the CLI flows like this:</p>
<ol class="arabic simple">
<li>The talus_client creates a new code model</li>
</ol>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># in talus_client/talus_client/api.py</span>
<span class="k">class</span> <span class="nc">TalusClient</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="c"># ...</span>
    <span class="k">def</span> <span class="nf">code_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code_name</span><span class="p">,</span> <span class="n">code_type</span><span class="p">,</span> <span class="n">tags</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create the code, and return the results&quot;&quot;&quot;</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;name&quot;</span><span class="p">:</span> <span class="n">code_name</span><span class="p">,</span>
            <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="n">code_type</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">tags</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_user</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tags</span><span class="p">:</span>
                <span class="n">tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_user</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tags</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s">&quot;tags&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">tags</span><span class="p">)</span>

        <span class="n">e</span> <span class="o">=</span> <span class="n">MultipartEncoder</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_base</span> <span class="o">+</span> <span class="s">&quot;/api/code/create/&quot;</span><span class="p">,</span>
                <span class="n">data</span>    <span class="o">=</span> <span class="n">e</span><span class="p">,</span>
                <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;Content-Type&quot;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">content_type</span><span class="p">}</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">ConnectionError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">TalusApiError</span><span class="p">(</span><span class="s">&quot;Could not connect to {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_api_base</span> <span class="o">+</span> <span class="s">&quot;/api/code/create&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">status_code</span> <span class="o">//</span> <span class="mi">100</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">errors</span><span class="o">.</span><span class="n">TalusApiError</span><span class="p">(</span><span class="s">&quot;Could not create code!&quot;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</pre></div>
</div>
<p>The master daemon sees the insert into the database, and creates a new tool/component folder
based on the template tool/component:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># in talus/src/master/watchers/code.py</span>
    <span class="k">def</span> <span class="nf">_handle_new_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">id_</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">code</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="n">code</span> <span class="o">=</span> <span class="n">master</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Code</span><span class="o">.</span><span class="n">objects</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">id_</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">code</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;new_&quot;</span><span class="p">):</span>
                    <span class="k">return</span>

            <span class="n">code</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;new_&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;creating new code from template ({}, {})&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">code</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">code</span><span class="o">.</span><span class="n">type</span><span class="p">))</span>

            <span class="c"># TODO this should be in some central setting somewhere,</span>
            <span class="c"># e.g. master.settings.TALUS_GIT or something</span>
            <span class="n">tmpdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
            <span class="n">git</span><span class="o">.</span><span class="n">clone</span><span class="p">(</span><span class="n">TALUS_GIT</span><span class="p">,</span> <span class="n">tmpdir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;cloned code into {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">tmpdir</span><span class="p">))</span>
    <span class="c"># ...</span>
</pre></div>
</div>
<p>After the master daemon has done its thing, everything should be good-to-go and the user
can <code class="code docutils literal"><span class="pre">git</span> <span class="pre">pull</span></code> and see the changes in the git repository.</p>
</div>
<div class="section" id="git-repo">
<h3>Git Repo<a class="headerlink" href="#git-repo" title="Permalink to this headline">¶</a></h3>
<p>The git repo has two hooks: a <code class="code docutils literal"><span class="pre">pre-receive</span></code> hook and a <code class="code docutils literal"><span class="pre">post-receive</span></code> hook.</p>
<div class="section" id="pre-receive">
<h4>Pre-Receive<a class="headerlink" href="#pre-receive" title="Permalink to this headline">¶</a></h4>
<p>The pre-receive hook uses the python docutils module to parse the python code into an AST
without having to import the code. Syntax errors will still be caught, but the code will
not actually run.</p>
<p>The pre-receive hook is responsible for validating and saving to the database parameter information defined in a tools run function,
as well as the parameters in a component&#8217;s init function.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># in talus/src/master/git_repo/hooks/pre-receive</span>
<span class="c"># ...</span>
<span class="k">class</span> <span class="nc">ChangeHandler</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
    <span class="c"># ...</span>
    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">changes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_changes</span><span class="p">()</span>

        <span class="n">switch</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">&quot;A&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_fileadd</span><span class="p">,</span>
            <span class="s">&quot;M&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_filemod</span><span class="p">,</span>
            <span class="s">&quot;D&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_filedel</span>
        <span class="p">}</span>
        <span class="n">success</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">filename</span><span class="p">,</span><span class="n">op</span> <span class="ow">in</span> <span class="n">changes</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="c"># we only care about tools in the talus/{components,tools} directories,</span>
            <span class="c"># and the __init__.py two levels deep:</span>
            <span class="c">#</span>
            <span class="c"># The main Tool and Component definitions are only going</span>
            <span class="c"># to be defined in the __init__.py file of the module,</span>
            <span class="c"># e.g.</span>
            <span class="c">#</span>
            <span class="c">#       tools/</span>
            <span class="c">#               browser_fuzzer/</span>
            <span class="c">#                       __init__.py &lt;--- contains the BrowserFuzzer class</span>
            <span class="c">#                       ... supporting files ...</span>
            <span class="c">#</span>
            <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&#39;^talus/(tools|components)/(\w+)/__init__.py&#39;</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">match</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">switch</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">switch</span><span class="p">[</span><span class="n">op</span><span class="p">](</span><span class="n">filename</span><span class="p">,</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">res</span><span class="p">:</span>
                    <span class="n">success</span> <span class="o">=</span> <span class="bp">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;unknown operation type {} for file {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_code_defs</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">success</span>
<span class="c"># ...</span>
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">errored</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">readlines</span><span class="p">():</span>
            <span class="n">oldrev</span><span class="p">,</span> <span class="n">newrev</span><span class="p">,</span> <span class="n">revname</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">handler</span> <span class="o">=</span> <span class="n">ChangeHandler</span><span class="p">(</span><span class="n">oldrev</span><span class="p">,</span> <span class="n">newrev</span><span class="p">,</span> <span class="n">revname</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">handler</span><span class="o">.</span><span class="n">handle</span><span class="p">():</span>
                <span class="n">errored</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">continue</span>
    <span class="k">except</span> <span class="n">TalusError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">errored</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="n">add_error_message</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">errored</span><span class="p">:</span>
        <span class="n">do_error</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ERROR_MESSAGES</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="section" id="post-receive">
<h4>Post-Receive<a class="headerlink" href="#post-receive" title="Permalink to this headline">¶</a></h4>
<p>The post-receive git hook is responsible for updating the talus code cache. The code
cache is talus&#8217; way of providing a means to do partial checkouts of a git repository.
(Unlike with svn, I have not found this to be possible).</p>
<p>The post-receive hook is found in <code class="code docutils literal"><span class="pre">talus/src/master/git_repo/hooks/post-receive</span></code></p>
<p>If permission issues arise with the talus_code_cache, check for inconsistent permissions
in <code class="code docutils literal"><span class="pre">/talus/talus_code_cache</span></code> on the talus master server, as that is the locally-cloned
talus repository that git-pull is performed on whenever a changeset is received.</p>
</div>
<div class="section" id="code-cache">
<h4>Code Cache<a class="headerlink" href="#code-cache" title="Permalink to this headline">¶</a></h4>
<p>The code cache has two parts - the post-receive hook mentioned above, and the django
web app that actually fetches information from the cloned git repo on the master. The
django web-app accepts requests of the form:</p>
<div class="highlight-bash"><div class="highlight"><pre>http://master.talus/code_cache/&lt;REF&gt;/path/to/resource
</pre></div>
</div>
<p>This resource is protected via basic authentication, with the username and password being:</p>
<div class="highlight-bash"><div class="highlight"><pre><span class="nv">user</span><span class="o">=</span><span class="s2">&quot;talus_job&quot;</span>
<span class="nv">password</span><span class="o">=</span><span class="s2">&quot;Monkeys eat bananas and poop all day.&quot;</span>
</pre></div>
</div>
<p>Sorry about the password - I think I had recently gone to the zoo, and I never felt like changing
it once it was in place. The hashed password itself is stored in <code class="code docutils literal"><span class="pre">talus/src/web/app/passwords</span></code>
if you really want to change it.</p>
<p>Sample output from the code cache looks like:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="c1">// for request on the directory http://master.talus/code_cache/HEAD/talus/</span>
<span class="p">{</span>
    <span class="s2">&quot;items&quot;</span><span class="o">:</span> <span class="p">[</span>
        <span class="s2">&quot;.gitignore&quot;</span><span class="p">,</span>
        <span class="s2">&quot;__init__.py&quot;</span><span class="p">,</span>
        <span class="s2">&quot;components/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;fileset.py&quot;</span><span class="p">,</span>
        <span class="s2">&quot;job.py&quot;</span><span class="p">,</span>
        <span class="s2">&quot;lib/&quot;</span><span class="p">,</span>
        <span class="s2">&quot;requirements.txt&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tools/&quot;</span>
     <span class="p">],</span>
     <span class="s2">&quot;type&quot;</span><span class="o">:</span> <span class="s2">&quot;listing&quot;</span><span class="p">,</span>
     <span class="s2">&quot;filename&quot;</span><span class="o">:</span> <span class="s2">&quot;talus/&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="task">
<h2>Task<a class="headerlink" href="#task" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="job">
<h2>Job<a class="headerlink" href="#job" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="results">
<h2>Results<a class="headerlink" href="#results" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="crashes">
<h2>Crashes<a class="headerlink" href="#crashes" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="master-daemon">
<h2>Master Daemon<a class="headerlink" href="#master-daemon" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="slave-daemon">
<h2>Slave Daemon<a class="headerlink" href="#slave-daemon" title="Permalink to this headline">¶</a></h2>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="debugging.html" class="btn btn-neutral" title="Debugging Talus" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Optiv Labs.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>